#/usr/bin/env bash

BLACKARCH_MOUNTED=/tmp/BLACKARCH_MOUNTED

chroot_setup() {
	if [ ! -f "$BLACKARCH_MOUNTED" ]
	then
		trap 'chroot_teardown' exit

		mount -t proc /proc /blackarch/proc/
		mount -t sysfs /sys /blackarch/sys/
		if [ -z "$(ls -A /blackarch/dev)" ]
		then
			mount -r --rbind /dev /blackarch/dev/
		fi
		cp /etc/resolv.conf /blackarch/etc/resolv.conf

		touch "$BLACKARCH_MOUNTED"
	fi

	chroot /blackarch su - blackarch
}

chroot_teardown() {
	rm "$BLACKARCH_MOUNTED"
	umount /blackarch/proc/
	umount /blackarch/sys/
}

chroot_setup
