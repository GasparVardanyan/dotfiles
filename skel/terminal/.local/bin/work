#/usr/bin/env bash

WORK_MOUNTED=/tmp/WORK_MOUNTED

chroot_setup() {
	if [ ! -f "$WORK_MOUNTED" ]
	then
		trap 'chroot_teardown' exit

		mount -t proc /proc /work/proc/
		mount -t sysfs /sys /work/sys/
		if [ -z "$(ls -A /work/dev)" ]
		then
			mount --rbind -r /dev /work/dev/
		fi

		cp /etc/resolv.conf /work/etc/resolv.conf

		touch "$WORK_MOUNTED"
	fi

	chroot /work su - improvis
}

chroot_teardown() {
	rm "$WORK_MOUNTED"
	umount /work/proc/
	umount /work/sys/
}

chroot_setup
