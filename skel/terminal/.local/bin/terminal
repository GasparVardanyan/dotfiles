#!/usr/bin/env bash

WORK_MOUNTED=/tmp/WORK_MOUNTED
BLACKARCH_MOUNTED=/tmp/BLACKARCH_MOUNTED

login_work() {
	if [ ! -f "$WORK_MOUNTED" ]
	then
		trap '_logout_work' exit

		mount -t proc /proc /work/proc/
		mount -t sysfs /sys /work/sys/
		if [ -z "$(ls -A /work/dev)" ]
		then
			mount --rbind -r /dev /work/dev/
		fi

		cp /etc/resolv.conf /work/etc/resolv.conf

		touch "$WORK_MOUNTED"
	fi

	chroot /work su - improvis
}

_logout_work() {
	rm "$WORK_MOUNTED"
	umount /work/proc/
	umount /work/sys/
}

login_blackarch() {
	if [ ! -f "$BLACKARCH_MOUNTED" ]
	then
		trap '_logout_blackarch' exit

		mount -t proc /proc /blackarch/proc/
		mount -t sysfs /sys /blackarch/sys/
		if [ -z "$(ls -A /blackarch/dev)" ]
		then
			mount -r --rbind /dev /blackarch/dev/
		fi
		cp /etc/resolv.conf /blackarch/etc/resolv.conf

		touch "$BLACKARCH_MOUNTED"
	fi

	chroot /blackarch su - blackarch
}

_logout_blackarch() {
	rm "$BLACKARCH_MOUNTED"
	umount /blackarch/proc/
	umount /blackarch/sys/
}

login() {
	l=$(echo -e "blackarch\nwork" | sort | dmenu -p 'terminal: ' -l 20)
	if [ "$l" != '' ]
	then
		case "$l" in
			blackarch)
				st_redish -n pop-up -g 120x30 -e sh -c 'sudo terminal login_blackarch'
			;;
			work)
				st_leet -n pop-up -g 120x30 -e sh -c 'sudo terminal login_work'
			;;
			*)
			;;
		esac
	fi
}

$1
